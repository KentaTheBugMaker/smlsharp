name: Makefile CI

on:
  push:
    branches: [ "master" ,"newer_llvm","automatic_test"]
  pull_request:
    branches: [ "master" ,"newer_llvm","automatic_test"]
# from PR #71 we can't compile bootstrap compiler with llvm-9 or earlier therefore we don't check compatiblity for that.
jobs:
#special case we need to install MassiveThreads mannually.
  llvm10:
    runs-on: ubuntu-20.04
    steps:
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
            packages: llvm-10 libgmp-dev
            version: 1.0
      - uses: actions/checkout@v4
        with:
            repository: 'massivethreads/massivethreads'
            ref: 'master'
            path: 'massivethreads'
      - name: install MassiveThreads
        working-directory: massivethreads
#the default install prefix is not suitable.
        run: |
            ./configure --prefix=/usr
            make -j4
            sudo make install
      - name: set symbolic link for llvm-config
        run: sudo ln -s /bin/llvm-config-10 /bin/llvm-config
      - uses: actions/checkout@v4
        with:
            path: 'smlsharp'
            fetch-depth: 0
      - name: configure
        working-directory: 'smlsharp'
        run: ./configure
      - name: make
        working-directory: 'smlsharp'
        run: make -j4
      - name: test
        working-directory: 'smlsharp'
        run: make test -j4
        env:
          TZ: 'Asia/Tokyo'
  llvm11:
    runs-on: ubuntu-22.04
    steps:
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
            packages: llvm-11 libgmp-dev libmassivethreads-dev
            version: 1.0
      - name: set symbolic link for llvm-config
        run: sudo ln -s /bin/llvm-config-11 /bin/llvm-config
      - uses: actions/checkout@v4
        with:
            path: 'smlsharp'
            fetch-depth: 0
      - name: configure
        working-directory: 'smlsharp'
        run: ./configure
      - name: make
        working-directory: 'smlsharp'
        run: make -j4
      - name: test
        working-directory: 'smlsharp'
        run: make test -j4
        env:
          TZ: 'Asia/Tokyo'
  llvm12:
    runs-on: ubuntu-22.04
    steps:
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
            packages: llvm-12 libgmp-dev libmassivethreads-dev
            version: 1.0
      - name: set symbolic link for llvm-config
        run: sudo ln -s /bin/llvm-config-12 /bin/llvm-config
      - uses: actions/checkout@v4
        with:
            path: 'smlsharp'
            fetch-depth: 0
      - name: configure
        working-directory: 'smlsharp'
        run: ./configure
      - name: make
        working-directory: 'smlsharp'
        run: make -j4
      - name: test
        working-directory: 'smlsharp'
        run: make test -j4
        env:
          TZ: 'Asia/Tokyo'
  llvm13:
    runs-on: ubuntu-22.04
    steps:
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
            packages: llvm-13 libgmp-dev libmassivethreads-dev
            version: 1.0
      - name: set symbolic link for llvm-config
        run: sudo ln -s /bin/llvm-config-13 /bin/llvm-config
      - uses: actions/checkout@v4
        with:
            path: 'smlsharp'
            fetch-depth: 0
      - name: configure
        working-directory: 'smlsharp'
        run: ./configure
      - name: make
        working-directory: 'smlsharp'
        run: make -j4
      - name: test
        working-directory: 'smlsharp'
        run: make test -j4
        env:
          TZ: 'Asia/Tokyo'
  llvm14:
    runs-on: ubuntu-24.04
    steps:
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
            packages: llvm-14 libgmp-dev libmassivethreads-dev
            version: 1.0
      - name: set symbolic link for llvm-config
        run: sudo ln -s /bin/llvm-config-14 /bin/llvm-config
      - uses: actions/checkout@v4
        with:
            path: 'smlsharp'
            fetch-depth: 0
      - name: configure
        working-directory: 'smlsharp'
        run: ./configure
      - name: make
        working-directory: 'smlsharp'
        run: make -j4
      - name: test
        working-directory: 'smlsharp'
        run: make test -j4
        env:
          TZ: 'Asia/Tokyo'
  llvm15:
    runs-on: ubuntu-24.04
    steps:
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
            packages: llvm-15 libgmp-dev libmassivethreads-dev
            version: 1.0
      - name: set symbolic link for llvm-config
        run: sudo ln -s /bin/llvm-config-15 /bin/llvm-config
      - uses: actions/checkout@v4
        with:
            path: 'smlsharp'
            fetch-depth: 0
      - name: configure
        working-directory: 'smlsharp'
        run: ./configure
      - name: make
        working-directory: 'smlsharp'
        run: make -j4
      - name: test
        working-directory: 'smlsharp'
        run: make test -j4
        env:
          TZ: 'Asia/Tokyo'
  llvm16:
    runs-on: ubuntu-24.04
    steps:
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
            packages: llvm-16 libgmp-dev libmassivethreads-dev
            version: 1.0
      - name: set symbolic link for llvm-config
        run: sudo ln -s /bin/llvm-config-16 /bin/llvm-config
      - uses: actions/checkout@v4
        with:
            path: 'smlsharp'
            fetch-depth: 0
      - name: configure
        working-directory: 'smlsharp'
        run: ./configure
      - name: make
        working-directory: 'smlsharp'
        run: make -j4
      - name: test
        working-directory: 'smlsharp'
        run: make test -j4
        env:
          TZ: 'Asia/Tokyo'
  llvm17:
    runs-on: ubuntu-24.04
    steps:
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
            packages: llvm-17 libgmp-dev libmassivethreads-dev
            version: 1.0
      - name: set symbolic link for llvm-config
        run: sudo ln -s /bin/llvm-config-17 /bin/llvm-config
      - uses: actions/checkout@v4
        with:
            path: 'smlsharp'
            fetch-depth: 0
      - name: configure
        working-directory: 'smlsharp'
        run: ./configure
      - name: make
        working-directory: 'smlsharp'
        run: make -j4
      - name: test
        working-directory: 'smlsharp'
        run: make test -j4
        env:
          TZ: 'Asia/Tokyo'
  llvm18:
    runs-on: ubuntu-24.04
    steps:
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
            packages: llvm-18 libgmp-dev libmassivethreads-dev
            version: 1.0
      - name: set symbolic link for llvm-config
        run: sudo ln -s /bin/llvm-config-18 /bin/llvm-config
      - uses: actions/checkout@v4
        with:
            path: 'smlsharp'
            fetch-depth: 0
      - name: configure
        working-directory: 'smlsharp'
        run: ./configure
      - name: make
        working-directory: 'smlsharp'
        run: make -j4
      - name: test
        working-directory: 'smlsharp'
        run: make test -j4
        env:
          TZ: 'Asia/Tokyo'